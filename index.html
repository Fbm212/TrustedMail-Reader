<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Monitor</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* NexaWallet Style Theme Variables */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #8b5cf6;
            --accent: #06d6a0;
            --text: #1e293b;
            --text-light: #64748b;
            --bg: #f8fafc;
            --card: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 10px;
            --input-bg: #ffffff;
            --border-color: #e2e8f0;
            --button-bg: #2563eb;
            --button-hover: #1d4ed8;
            --button-disabled: #94a3b8;
            --readonly-bg: #f1f5f9;
            --readonly-text: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --running: #3b82f6;
        }

        /* Dark Mode */
        .dark-mode {
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --bg: #0f172a;
            --card: #1e293b;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --input-bg: #334155;
            --border-color: #475569;
            --button-bg: #2563eb;
            --button-hover: #1d4ed8;
            --button-disabled: #475569;
            --readonly-bg: #334155;
            --readonly-text: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --running: #3b82f6;
        }

        /* Global Styles - Mobile First */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        /* Profile Row - With Theme Toggle on Right */
        .profile-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .profile-info-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--primary);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .profile-info p {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--input-bg);
            border-color: var(--primary);
        }

        /* Stats Row - Two items side by side */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: var(--card);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Email Input Section */
        .email-section {
            background: var(--card);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        .email-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--input-bg);
            color: var(--text);
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .email-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Control Grid - Three items side by side */
        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-box {
            background: var(--card);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .control-label {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .start-btn {
            background: var(--button-bg);
            color: white;
            border: none;
            padding: 10px;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .start-btn:hover {
            background: var(--button-hover);
            transform: translateY(-2px);
        }

        .start-btn:disabled {
            background: var(--button-disabled);
            cursor: not-allowed;
            transform: none;
        }

        .status-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-ready { background: var(--success); }
        .status-running { 
            background: var(--running);
            animation: pulse 1.5s infinite; 
        }
        .status-received { background: var(--primary); }

        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .timer {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        .timer-countdown {
            color: var(--warning);
            font-size: 1.2rem;
        }

        /* OTP List Section */
        .otp-section {
            background: var(--card);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .otp-section h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .otp-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .otp-list::-webkit-scrollbar {
            width: 4px;
        }

        .otp-list::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 2px;
        }

        .otp-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .otp-item {
            background: var(--input-bg);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid var(--primary);
            transition: all 0.3s ease;
        }

        .otp-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .otp-code {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .otp-code span {
            letter-spacing: 3px;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .copy-btn:hover {
            background: var(--primary-dark);
        }

        .copy-btn.copied {
            background: var(--success);
        }

        .otp-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .no-otp {
            text-align: center;
            padding: 30px;
            color: var(--text-light);
            font-style: italic;
        }

        /* Flash Alert - Bottom Center for Mobile */
        .flash-alert {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            z-index: 1000;
            font-size: 0.9rem;
            font-weight: 500;
            max-width: 90%;
            text-align: center;
        }

        .flash-alert.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Loading Overlay */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1001;
            backdrop-filter: blur(5px);
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.4s ease-out;
        }

        /* Responsive Design - Fixed for Mobile */
        @media (max-width: 768px) {
            /* ‡¶∏‡¶ï‡¶≤ ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° */
            .container {
                padding: 10px;
            }

            .profile-row {
                padding: 12px;
            }

            .stats-row,
            .control-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .control-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .stat-item,
            .control-box,
            .email-section,
            .otp-section {
                padding: 12px;
            }

            .timer {
                font-size: 1rem;
            }

            .otp-code {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .profile-row {
                flex-direction: row;
                align-items: center;
            }

            .profile-info-section {
                flex: 1;
            }

            .theme-toggle {
                flex-shrink: 0;
            }

            .control-grid {
                gap: 8px;
            }

            .control-label {
                font-size: 0.7rem;
            }

            .status-display {
                font-size: 0.85rem;
            }

            .timer-countdown {
                font-size: 1rem;
            }

            .otp-item {
                padding: 12px;
            }

            .otp-code {
                font-size: 1.1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .copy-btn {
                align-self: flex-start;
            }

            .otp-meta {
                flex-direction: column;
                gap: 5px;
            }
        }

        /* Desktop Mode Fix - Prevent Desktop Layout */
        @media (min-width: 769px) {
            .container {
                max-width: 500px;
                margin: 0 auto;
            }
            
            /* Keep mobile layout on desktop */
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Profile Row with Theme Toggle on Right -->
        <div class="profile-row fade-in">
            <div class="profile-info-section">
                <div class="profile-avatar">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=User123" alt="Profile">
                </div>
                <div class="profile-info">
                    <h2 id="userName">User Name</h2>
                    <p id="userId">User ID: <span id="userIdValue">Loading...</span></p>
                </div>
            </div>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>
        
        <!-- Stats Row (2 items side by side) -->
        <div class="stats-row fade-in">
            <div class="stat-item">
                <div class="stat-label">Emails Monitored</div>
                <div class="stat-value" id="uniqueEmailCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">OTPs Received</div>
                <div class="stat-value" id="receivedOtpCount">0</div>
            </div>
        </div>
        
        <!-- Email Input -->
        <div class="email-section fade-in">
            <input 
                type="email" 
                id="emailInput" 
                class="email-input" 
                placeholder="Enter email address to monitor..."
                value=""
            >
        </div>
        
        <!-- Control Grid (3 items side by side) -->
        <div class="control-grid fade-in">
            <!-- Start Button -->
            <div class="control-box">
                <div class="control-label">Action</div>
                <button id="startBtn" class="start-btn">
                    <i class="fas fa-play"></i> Start
                </button>
            </div>
            
            <!-- Status -->
            <div class="control-box">
                <div class="control-label">Status</div>
                <div class="status-display">
                    <div class="status-dot status-ready" id="statusDot"></div>
                    <span id="statusText">Ready</span>
                </div>
            </div>
            
            <!-- Timer -->
            <div class="control-box">
                <div class="control-label">Timer</div>
                <div class="timer-container">
                    <div class="timer timer-countdown" id="countdownTimer">05</div>
                    <div class="timer" id="totalTimer">00:00</div>
                </div>
            </div>
        </div>
        
        <!-- OTP List -->
        <div class="otp-section fade-in">
            <h2><i class="fas fa-key"></i> Received OTPs</h2>
            <div class="otp-list" id="otpList">
                <div class="no-otp" id="noOtp">
                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                    <div>No OTPs received yet.</div>
                    <div style="font-size: 0.9rem; margin-top: 5px;">Start monitoring to see OTPs</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Flash Alert -->
    <div class="flash-alert" id="flashAlert">
        <span id="flashMessage">Message</span>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = '7734169736:AAGDFW2mVkNSLrrPClDohEfNE0whlwmBiuE';
        
        // Application State
        const state = {
            currentEmail: '',
            isMonitoring: false,
            scanInterval: null,
            countdown: 5,
            totalTime: 0,
            currentStatus: 'ready',
            currentOtps: [],
            allOtpsForCurrentEmail: [], // ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá‡¶∞ ‡¶∏‡¶¨ OTP ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£
            telegramUserId: null,
            userProfile: {
                name: 'User Name',
                id: 'Loading...'
            }
        };
        
        // DOM Elements
        const elements = {
            themeToggle: document.getElementById('themeToggle'),
            userName: document.getElementById('userName'),
            userIdValue: document.getElementById('userIdValue'),
            uniqueEmailCount: document.getElementById('uniqueEmailCount'),
            receivedOtpCount: document.getElementById('receivedOtpCount'),
            emailInput: document.getElementById('emailInput'),
            startBtn: document.getElementById('startBtn'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            countdownTimer: document.getElementById('countdownTimer'),
            totalTimer: document.getElementById('totalTimer'),
            otpList: document.getElementById('otpList'),
            noOtp: document.getElementById('noOtp'),
            flashAlert: document.getElementById('flashAlert'),
            flashMessage: document.getElementById('flashMessage'),
            loading: document.getElementById('loading')
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initTelegramUser();
            setupEventListeners();
            updateStats();
        });
        
        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                updateThemeIcon('light');
            }
        }
        
        function toggleTheme() {
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                updateThemeIcon('dark');
            } else {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                updateThemeIcon('light');
            }
        }
        
        function updateThemeIcon(targetTheme) {
            const icon = elements.themeToggle.querySelector('i');
            if (targetTheme === 'dark') {
                icon.className = 'fas fa-moon';
            } else {
                icon.className = 'fas fa-sun';
            }
        }
        
        // Telegram User Initialization
        function initTelegramUser() {
            // Check if Telegram Web App is available
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                const user = tg.initDataUnsafe?.user;
                
                if (user) {
                    state.userProfile.name = user.first_name || 'Telegram User';
                    state.userProfile.id = user.id.toString();
                    state.telegramUserId = user.id;
                    
                    // Update UI
                    elements.userName.textContent = state.userProfile.name;
                    elements.userIdValue.textContent = state.userProfile.id;
                    
                    // Set avatar
                    if (user.photo_url) {
                        document.querySelector('.profile-avatar img').src = user.photo_url;
                    }
                    
                    console.log('Telegram user initialized:', state.userProfile);
                }
            }
            
            // Fallback if no Telegram
            if (!state.telegramUserId) {
                // For testing purposes
                state.userProfile.name = 'Demo User';
                state.userProfile.id = 'demo-001';
                state.telegramUserId = 'demo-001';
                
                elements.userName.textContent = state.userProfile.name;
                elements.userIdValue.textContent = state.userProfile.id;
            }
        }
        
        // Event Listeners
        function setupEventListeners() {
            elements.themeToggle.addEventListener('click', toggleTheme);
            elements.startBtn.addEventListener('click', toggleMonitoring);
            
            // Copy OTP functionality
            document.addEventListener('click', function(e) {
                if (e.target.closest('.copy-btn')) {
                    const btn = e.target.closest('.copy-btn');
                    const otp = btn.getAttribute('data-otp');
                    copyToClipboard(otp, btn);
                }
            });
        }
        
        // Monitoring Control - UPDATED LOGIC
        async function toggleMonitoring() {
            const email = elements.emailInput.value.trim();
            
            if (!email || !isValidEmail(email)) {
                showFlash('Enter valid email');
                return;
            }
            
            if (!state.isMonitoring) {
                await startMonitoring(email);
            } else {
                stopMonitoring();
            }
        }
        
        async function startMonitoring(email) {
            // Reset state for new monitoring session
            state.currentEmail = email;
            state.isMonitoring = true;
            state.currentStatus = 'running';
            state.countdown = 5;
            state.totalTime = 0;
            
            // Clear only if different email
            if (state.currentEmail !== email) {
                state.currentOtps = [];
                state.allOtpsForCurrentEmail = [];
            }
            
            // Update UI
            elements.emailInput.disabled = true;
            elements.startBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
            elements.startBtn.style.background = 'var(--danger)';
            updateStatus('running');
            updateTimers();
            updateStats();
            
            // First scan: ‡¶≤‡ßã‡¶° existing OTPs
            await scanEmail(true);
            
            // Start timers for continuous scanning
            startTimers();
            
            showFlash('Monitoring started');
        }
        
        function stopMonitoring() {
            // Clear intervals
            if (state.scanInterval) {
                clearInterval(state.scanInterval);
                state.scanInterval = null;
            }
            
            // Update state
            state.isMonitoring = false;
            state.currentStatus = 'ready';
            
            // Update UI
            elements.emailInput.disabled = false;
            elements.startBtn.innerHTML = '<i class="fas fa-play"></i> Start';
            elements.startBtn.style.background = 'var(--button-bg)';
            updateStatus('ready');
            
            showFlash('Monitoring stopped');
        }
        
        // Timer Management
        function startTimers() {
            // Clear existing interval
            if (state.scanInterval) {
                clearInterval(state.scanInterval);
            }
            
            // Start new interval
            state.scanInterval = setInterval(async () => {
                // Update countdown
                state.countdown--;
                
                // Update total time
                state.totalTime++;
                
                // Update UI
                updateTimers();
                
                // Check if countdown reached 0
                if (state.countdown <= 0) {
                    // Reset countdown
                    state.countdown = 5;
                    
                    // Trigger email scan for NEW OTPs only
                    await scanEmail(false);
                }
            }, 1000);
        }
        
        function updateTimers() {
            // Countdown timer (5 to 0)
            elements.countdownTimer.textContent = state.countdown.toString().padStart(2, '0');
            
            // Total timer (MM:SS)
            const minutes = Math.floor(state.totalTime / 60);
            const seconds = state.totalTime % 60;
            elements.totalTimer.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Email Scanning - UPDATED LOGIC
        async function scanEmail(isInitialScan = false) {
            if (!state.isMonitoring || !state.currentEmail) return;
            
            if (!isInitialScan) {
                elements.loading.classList.add('active');
            }
            
            try {
                const apiUrl = `http://devpritom.0web.top/readmail.php?readmail=${encodeURIComponent(state.currentEmail)}`;
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                await processOtps(data, isInitialScan);
                
            } catch (error) {
                console.error('Scan failed:', error);
                if (!isInitialScan) {
                    showFlash('Scan failed');
                }
            } finally {
                if (!isInitialScan) {
                    elements.loading.classList.remove('active');
                }
            }
        }
        
        async function processOtps(apiData, isInitialScan = false) {
            let otps = [];
            
            // Parse OTPs from API response
            if (Array.isArray(apiData)) {
                otps = apiData;
            } else if (apiData.otps && Array.isArray(apiData.otps)) {
                otps = apiData.otps;
            } else if (apiData.code) {
                otps = [{
                    code: apiData.code,
                    sender: apiData.sender || 'Unknown',
                    time: new Date().toLocaleTimeString()
                }];
            }
            
            if (otps.length === 0) {
                if (isInitialScan) {
                    showFlash('No OTPs found');
                }
                return;
            }
            
            if (isInitialScan) {
                // Initial scan: ‡¶∏‡¶¨ OTPs ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                for (const otp of otps) {
                    const otpData = {
                        code: otp.code,
                        sender: otp.sender || 'Unknown',
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString(),
                        timestamp: Date.now(),
                        email: state.currentEmail,
                        isNew: false // Initial OTPs ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã
                    };
                    
                    // Avoid duplicates
                    if (!state.allOtpsForCurrentEmail.some(existing => existing.code === otp.code)) {
                        state.allOtpsForCurrentEmail.push(otpData);
                        state.currentOtps.unshift(otpData);
                    }
                }
                
                updateOtpList();
                updateStats();
                showFlash(`${otps.length} existing OTPs loaded`);
                
            } else {
                // Subsequent scans: ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶®‡¶§‡ßÅ‡¶® OTPs ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
                const newOtps = otps.filter(otp => {
                    return !state.allOtpsForCurrentEmail.some(existing => existing.code === otp.code);
                });
                
                if (newOtps.length > 0) {
                    for (const otp of newOtps) {
                        const otpData = {
                            code: otp.code,
                            sender: otp.sender || 'Unknown',
                            date: new Date().toLocaleDateString(),
                            time: new Date().toLocaleTimeString(),
                            timestamp: Date.now(),
                            email: state.currentEmail,
                            isNew: true // ‡¶®‡¶§‡ßÅ‡¶® OTP
                        };
                        
                        // Add to both lists
                        state.allOtpsForCurrentEmail.push(otpData);
                        state.currentOtps.unshift(otpData);
                        
                        // Send to Telegram
                        const sent = await sendToTelegram(otpData);
                        
                        if (sent) {
                            // Stop monitoring on successful new OTP
                            stopMonitoring();
                            updateStatus('received');
                            
                            // Update UI
                            updateOtpList();
                            updateStats();
                            
                            // Show success message
                            showFlash(`New OTP: ${otp.code}`);
                            
                            // Break after first new OTP
                            break;
                        }
                    }
                }
            }
        }
        
        // Telegram Integration
        async function sendToTelegram(otp) {
            if (!TELEGRAM_BOT_TOKEN || !state.telegramUserId) {
                console.log('Telegram not configured');
                return false;
            }
            
            try {
                const message = `üîî *New OTP Received!*\n\nüìß *Email:* ${otp.email}\nüîë *OTP Code:* \`${otp.code}\`\nüì® *From:* ${otp.sender}\nüìÖ *Date:* ${otp.date}\n‚è∞ *Time:* ${otp.time}`;
                
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chat_id: state.telegramUserId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (response.ok) {
                    console.log('OTP sent to Telegram successfully');
                    return true;
                } else {
                    console.error('Telegram API error:', await response.text());
                    return false;
                }
                
            } catch (error) {
                console.error('Telegram error:', error);
                return false;
            }
        }
        
        // UI Updates
        function updateStats() {
            // Show 1 if email is entered, 0 otherwise
            elements.uniqueEmailCount.textContent = state.currentEmail ? '1' : '0';
            
            // Show total OTPs for current email
            elements.receivedOtpCount.textContent = state.currentOtps.length;
        }
        
        function updateStatus(status) {
            state.currentStatus = status;
            
            // Update dot
            elements.statusDot.className = 'status-dot';
            elements.statusDot.classList.add(`status-${status}`);
            
            // Update text
            switch(status) {
                case 'ready':
                    elements.statusText.textContent = 'Ready';
                    break;
                case 'running':
                    elements.statusText.textContent = 'Running';
                    break;
                case 'received':
                    elements.statusText.textContent = 'Received';
                    break;
            }
        }
        
        function updateOtpList() {
            if (state.currentOtps.length === 0) {
                elements.noOtp.style.display = 'block';
                elements.otpList.innerHTML = '';
                return;
            }
            
            elements.noOtp.style.display = 'none';
            
            // Sort by timestamp (newest first)
            const sortedOtps = [...state.currentOtps].sort((a, b) => b.timestamp - a.timestamp);
            
            const otpItems = sortedOtps.map(otp => `
                <div class="otp-item" style="border-left-color: ${otp.isNew ? 'var(--success)' : 'var(--primary)'}">
                    <div class="otp-code">
                        <span>${otp.code}</span>
                        <button class="copy-btn" data-otp="${otp.code}" title="Copy OTP">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="otp-meta">
                        <span>From: ${otp.sender}</span>
                        <span>${otp.date} ${otp.time}</span>
                    </div>
                    ${otp.isNew ? '<div style="font-size: 0.7rem; color: var(--success); margin-top: 5px;"><i class="fas fa-star"></i> New</div>' : ''}
                </div>
            `).join('');
            
            elements.otpList.innerHTML = otpItems;
        }
        
        // Flash Alert
        function showFlash(message) {
            elements.flashMessage.textContent = message;
            elements.flashAlert.classList.add('show');
            
            setTimeout(() => {
                elements.flashAlert.classList.remove('show');
            }, 2000);
        }
        
        // Copy to Clipboard
        async function copyToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                
                // Visual feedback
                const icon = button.querySelector('i');
                const originalText = button.textContent;
                icon.className = 'fas fa-check';
                button.textContent = ' Copied';
                button.classList.add('copied');
                
                setTimeout(() => {
                    icon.className = 'fas fa-copy';
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
                
                showFlash('Copied to clipboard');
            } catch (err) {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showFlash('Copied to clipboard');
            }
        }
        
        // Validation
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
    </script>
</body>
</html>
